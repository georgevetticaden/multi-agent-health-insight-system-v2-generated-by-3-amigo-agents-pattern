<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ report_title }}</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom right, #0f172a, #1e3a8a, #581c87);
      min-height: 100vh;
      color: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .container {
      padding: 32px;
    }
    h1, h2, h3, h4 {
      color: white;
      margin: 0 0 16px 0;
    }
    a {
      color: #60a5fa;
      text-decoration: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #e5e7eb;
    }
    th {
      text-align: left;
      padding: 12px;
    }
    td {
      padding: 12px;
    }
    
    /* Collapsible sections */
    .collapsible {
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
    }
    .collapsible:hover {
      background: rgba(255,255,255,0.08);
    }
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
    }
    .collapsible-arrow {
      transition: transform 0.3s ease;
      font-size: 1.2rem;
    }
    .collapsible-arrow.open {
      transform: rotate(180deg);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .collapsible-content.open {
      max-height: 3000px;
    }
    
    /* Failure analysis styling */
    .failure-card {
      background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05));
      border: 2px solid rgba(239,68,68,0.3);
      border-radius: 16px;
      padding: 24px;
      margin-top: 24px;
      position: relative;
      overflow: hidden;
    }
    .failure-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ef4444, #dc2626, #ef4444);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    .failure-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .failure-icon {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(239,68,68,0.3);
    }
    .failure-item {
      background: rgba(0,0,0,0.2);
      border-left: 4px solid #ef4444;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 8px;
    }
    .recommendation-box {
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    .progress-bar {
      background: rgba(255,255,255,0.1);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    .progress-target {
      position: absolute;
      top: -2px;
      bottom: -2px;
      width: 2px;
      background: #60a5fa;
    }
    .test-card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .test-card-header {
      background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(6,182,212,0.3));
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
<div class="container">

<h1 style="font-size: 48px; margin-bottom: 16px;">üìä {{ report_title }}</h1>
<div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
  <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
    <strong style="color: #60a5fa;">üèóÔ∏è Multi-Agent Architecture:</strong> This evaluation framework follows Anthropic's best practices for testing multi-agent systems, 
    with the CMO agent serving as the orchestrator that delegates to specialist agents - mirroring the "research lead" pattern described in 
    <a href="https://www.anthropic.com/engineering/built-multi-agent-research-system" style="color: #a78bfa;">"Building Multi-Agent Research Systems"</a>.
  </p>
</div>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 24px; border-radius: 16px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">
  <div style="font-size: 1.125rem; font-weight: 600; color: #60a5fa;">Test Suite: {{ test_suite }}</div>
  {% if test_suite_description %}
  <div style="font-size: 0.875rem; color: #e5e7eb; font-style: italic; margin-top: 4px;">{{ test_suite_description }}</div>
  {% endif %}
</div>

{% if test_suite_detailed_description %}
<div style="color: #e5e7eb; margin-bottom: 24px;">
{{ test_suite_detailed_description }}
</div>
{% endif %}

<div style="display: flex; gap: 16px; margin: 20px 0;">
  <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 8px; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.1); color: white;">
    <strong style="color: #60a5fa;">Date:</strong> {{ timestamp }}
  </div>
  <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 8px; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.1); color: white;">
    <strong style="color: #60a5fa;">Evaluation Type:</strong> Hybrid (Deterministic + LLM Judge)
  </div>
</div>

<hr style="border: 0; height: 1px; background: rgba(255,255,255,0.1); margin: 32px 0;">

<h2 style="color: white; display: flex; align-items: center; gap: 12px;">
  <span style="background: rgba(59,130,246,0.2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üî¨</span>
  Evaluation Methodology
</h2>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 32px; border: 1px solid rgba(255,255,255,0.1);">
  <h3 style="color: white; margin: 0 0 16px 0;">üéØ Five Dimensions of CMO Agent Performance</h3>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
    <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px;">
      <h4 style="color: #60a5fa; margin: 0 0 8px 0;">1. Complexity Classification</h4>
      <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
        Evaluates if the CMO correctly identifies query complexity (SIMPLE ‚Üí COMPREHENSIVE).
        <br><span style="color: #94a3b8;">Method: Hybrid (rule-based + LLM verification)</span>
      </p>
    </div>
    
    <div style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.3); border-radius: 12px; padding: 16px;">
      <h4 style="color: #a78bfa; margin: 0 0 8px 0;">2. Specialist Selection</h4>
      <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
        Measures precision and recall of selecting appropriate medical specialists.
        <br><span style="color: #94a3b8;">Method: LLM Judge with semantic similarity</span>
      </p>
    </div>
    
    <div style="background: rgba(236,72,153,0.1); border: 1px solid rgba(236,72,153,0.3); border-radius: 12px; padding: 16px;">
      <h4 style="color: #ec4899; margin: 0 0 8px 0;">3. Analysis Quality</h4>
      <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
        Assesses comprehensiveness of the orchestration plan and task delegation.
        <br><span style="color: #94a3b8;">Method: LLM Judge scoring on 5 components</span>
      </p>
    </div>
    
    <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; padding: 16px;">
      <h4 style="color: #10b981; margin: 0 0 8px 0;">4. Tool Usage</h4>
      <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
        Validates effective use of health data query tools for initial assessment.
        <br><span style="color: #94a3b8;">Method: Deterministic validation</span>
      </p>
    </div>
    
    <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; padding: 16px;">
      <h4 style="color: #fbbf24; margin: 0 0 8px 0;">5. Response Structure</h4>
      <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
        Ensures compliance with required XML format for downstream processing.
        <br><span style="color: #94a3b8;">Method: Deterministic XML validation</span>
      </p>
    </div>
  </div>
  
  <div style="margin-top: 20px; padding: 16px; background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); border-radius: 12px;">
    <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
      <strong style="color: #60a5fa;">üìö Based on Anthropic's Testing Best Practices:</strong> This evaluation framework implements the hybrid approach recommended in Anthropic's 
      <a href="https://www.anthropic.com/engineering/built-multi-agent-research-system" style="color: #a78bfa;">testing guidelines</a>, combining:
    </p>
    <ul style="margin: 8px 0 0 20px; color: #e5e7eb; font-size: 0.875rem;">
      <li><strong>Deterministic checks</strong> for objective criteria (tool usage, XML structure)</li>
      <li><strong>LLM Judges</strong> for subjective quality assessment (analysis comprehensiveness, specialist selection appropriateness)</li>
      <li><strong>Semantic similarity</strong> for flexibility in specialist naming (e.g., "primary_care" ‚âà "general_practice")</li>
    </ul>
  </div>
</div>

<h2 style="color: white; display: flex; align-items: center; gap: 12px;">
  <span style="background: rgba(59,130,246,0.2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üéØ</span>
  Executive Summary
</h2>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">
  <h3 style="display: flex; align-items: center; gap: 8px; margin: 0 0 16px 0; color: white;">
    <span style="font-size: 1.5rem;">{{ overall_result_icon }}</span>
    CMO Agent Test Suite: <span style="background: {{ overall_result_color }}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.875rem; margin-left: 8px;">{{ overall_result }}</span>
  </h3>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
    <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
      <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 4px;">Overall Score</div>
      <div style="font-size: 2rem; font-weight: 700; color: white;">{{ overall_score }}%</div>
    </div>
    <div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
      <div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 4px;">Test Cases Evaluated</div>
      <div style="font-size: 2rem; font-weight: 700; color: white;">{{ total_tests }}</div>
    </div>
  </div>
  
  {% if overall_result == 'FAILED' %}
  <div style="background: rgba(239,68,68,0.1); padding: 16px; border-radius: 8px; margin-top: 16px; border: 1px solid rgba(239,68,68,0.3);">
    <strong style="color: #fca5a5;">Failure Reason:</strong> <span style="color: #e5e7eb;">One or more evaluation dimensions did not meet their minimum threshold requirements.</span>
    <div style="font-size: 0.875rem; color: #cbd5e1; margin-top: 4px; font-style: italic;">
      Each test case is evaluated on 5 dimensions. The test suite fails if ANY dimension's average score across all tests falls below its target threshold.
    </div>
  </div>
  
  <div style="margin-top: 16px; color: white;">
    <strong style="color: #fca5a5;">Failed Dimensions:</strong> {{ failed_dimensions|length }} of 5
    <ul style="margin-top: 8px; color: #fca5a5;">
      {% for dimension in failed_dimensions %}
      <li>{{ dimension }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

<h3 style="color: white;">Test Case Summary</h3>
<div style="font-size: 0.875rem; color: #94a3b8; font-style: italic; margin-bottom: 12px;">
  Individual test results with dimension failures
  <span style="display: inline-block; margin-left: 12px; background: rgba(59,130,246,0.1); padding: 4px 12px; border-radius: 12px; border: 1px solid rgba(59,130,246,0.3);">
    <strong>‚ÑπÔ∏è Note:</strong> Tests PASS only when ALL evaluation dimensions meet their target thresholds
  </span>
</div>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">
  <table style="width: 100%; border-collapse: collapse; color: white;">
    <thead>
      <tr style="background: linear-gradient(135deg, #3b82f6, #06b6d4);">
        <th style="color: white; padding: 12px 16px; text-align: left;">Test Case</th>
        <th style="color: white; padding: 12px 16px; text-align: left;">Status</th>
        <th style="color: white; padding: 12px 16px; text-align: left;">Failed Dimensions</th>
        <th style="color: white; padding: 12px 16px; text-align: left;">Complexity</th>
      </tr>
    </thead>
    <tbody>
      {% for test in test_summary %}
      <tr style="{% if loop.index0 % 2 == 1 %}background: rgba(255,255,255,0.02); {% endif %}border-bottom: 1px solid rgba(255,255,255,0.1);">
        <td style="padding: 12px 16px; color: #e5e7eb;">{{ test.test_case_id }}</td>
        <td style="padding: 12px 16px;">
          <span style="background: {{ test.status_color }}; color: {{ test.status_text_color }}; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem;">{{ test.status }}</span>
        </td>
        <td style="padding: 12px 16px; color: #e5e7eb;">{{ test.failed_dimensions_text }}</td>
        <td style="padding: 12px 16px;">
          <span style="background: {{ test.complexity_color }}; color: {{ test.complexity_text_color }}; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">{{ test.complexity }}</span>
        </td>
      </tr>
      {% endfor %}
      <tr style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(168,85,247,0.2)); font-weight: 600;">
        <td style="padding: 12px 16px; color: white;">TOTAL</td>
        <td style="padding: 12px 16px; color: white;">{{ tests_passed }}/{{ total_tests }} Passed</td>
        <td style="padding: 12px 16px; color: white;">{{ total_tests - tests_passed }} tests with failures</td>
        <td style="padding: 12px 16px; color: white;">-</td>
      </tr>
    </tbody>
  </table>
</div>

<h3 style="color: white;">Dimension Performance Across All Tests</h3>
<div style="font-size: 0.875rem; color: #94a3b8; font-style: italic; margin-bottom: 12px;">
  Average scores across all test cases for each evaluation dimension
  <span style="display: inline-block; margin-left: 12px; background: rgba(168,85,247,0.1); padding: 4px 12px; border-radius: 12px; border: 1px solid rgba(168,85,247,0.3);">
    <strong>üéØ Anthropic Best Practice:</strong> Hybrid evaluation using both deterministic checks and LLM judges
  </span>
</div>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">
  {% for dimension in dimension_performance %}
  <div style="margin-bottom: 20px;">
    <div style="font-weight: 600; color: #e5e7eb; margin-bottom: 4px;">{{ dimension.name }}</div>
    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
      <span style="color: #cbd5e1;">Score: <strong style="color: {{ dimension.score_color }};">{{ dimension.score_percent }}%</strong></span>
      <span style="color: #cbd5e1;">Target: {{ dimension.target_percent }}%</span>
    </div>
    <div class="progress-bar">
      <div style="width: {{ dimension.score_percent }}%; height: 100%; background: {{ dimension.progress_gradient }};"></div>
      <div class="progress-target" style="left: {{ dimension.target_percent }}%;"></div>
    </div>
    <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">{{ dimension.method_icon }} {{ dimension.method }} ‚Ä¢ {{ dimension.description }}</div>
  </div>
  {% endfor %}
  
  {% if dimension_failure_details %}
  <div style="background: rgba(239,68,68,0.1); padding: 16px; border-radius: 8px; margin-top: 20px; border: 1px solid rgba(239,68,68,0.2);">
    <strong style="color: #fca5a5;">Dimension Failure Details:</strong>
    <ul style="margin-top: 8px; color: #e5e7eb;">
      {% for detail in dimension_failure_details %}
      <li><strong>{{ detail.dimension }}:</strong> {{ detail.failed_count }} of {{ detail.total_count }} tests failed ({{ detail.percentage }}%)</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

{% if prompt_improvements.has_improvements %}
<h2 style="color: white; display: flex; align-items: center; gap: 12px;">
  <span style="background: linear-gradient(135deg, #ec4899, #8b5cf6); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üéØ</span>
  LLM Judge Prompt Improvement Recommendations
</h2>

<div style="background: linear-gradient(135deg, rgba(236,72,153,0.1), rgba(139,92,246,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
  <p style="margin: 0 0 16px 0; color: #e5e7eb;">
    <strong style="color: #ec4899;">ü§ñ AI-Powered Analysis:</strong> Our LLM Judge analyzed {{ total_tests }} test cases and identified specific improvements needed across {{ prompt_improvements.total_files }} prompt files. Each recommendation is based on actual test failures and includes the exact prompt content.
  </p>
  
  <div style="display: flex; gap: 24px; margin-top: 16px;">
    <div style="flex: 1; background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
      <div style="font-size: 2rem; font-weight: bold; color: #ec4899;">{{ prompt_improvements.total_files }}</div>
      <div style="font-size: 0.875rem; color: #94a3b8;">Prompts Need Updates</div>
    </div>
    <div style="flex: 1; background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;">
      <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">
        {% set high_priority = prompt_improvements.improvements | selectattr("priority", "equalto", "high") | list | length %}
        {{ high_priority }}
      </div>
      <div style="font-size: 0.875rem; color: #94a3b8;">High Priority Changes</div>
    </div>
  </div>
</div>

{% for improvement in prompt_improvements.improvements %}
<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; margin-bottom: 20px;">
  <!-- Header with priority indicator -->
  <div style="background: {% if improvement.priority == 'high' %}linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.1)){% elif improvement.priority == 'medium' %}linear-gradient(135deg, rgba(251,191,36,0.2), rgba(251,191,36,0.1)){% else %}linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1)){% endif %}; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; color: white; font-size: 1.25rem;">üìÑ {{ improvement.file }}</h3>
      <div style="display: flex; gap: 12px; align-items: center;">
        <span style="background: {% if improvement.priority == 'high' %}rgba(239,68,68,0.3){% elif improvement.priority == 'medium' %}rgba(251,191,36,0.3){% else %}rgba(34,197,94,0.3){% endif %}; color: {% if improvement.priority == 'high' %}#fca5a5{% elif improvement.priority == 'medium' %}#fcd34d{% else %}#86efac{% endif %}; padding: 6px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 600;">
          {{ improvement.priority|upper }} PRIORITY
        </span>
        <span style="background: rgba(139,92,246,0.2); color: #c4b5fd; padding: 6px 12px; border-radius: 6px; font-size: 0.875rem;">
          Affects {{ improvement.test_count }} test{{ 's' if improvement.test_count > 1 else '' }}
        </span>
      </div>
    </div>
    <div style="margin-top: 8px;">
      <code style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; color: #94a3b8;">{{ improvement.full_path }}</code>
    </div>
  </div>
  
  <div style="padding: 20px;">
    <!-- Issues Identified -->
    {% if improvement.issues %}
    <div style="margin-bottom: 20px;">
      <h4 style="color: #fbbf24; margin: 0 0 12px 0; font-size: 1rem;">üîç Issues Identified</h4>
      <ul style="margin: 0; padding-left: 20px; color: #e5e7eb;">
        {% for issue in improvement.issues %}
        {% if issue %}
        <li style="margin-bottom: 8px; line-height: 1.5;">{{ issue }}</li>
        {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    
    <!-- Recommended Changes -->
    {% if improvement.changes %}
    <div style="margin-bottom: 20px;">
      <h4 style="color: #60a5fa; margin: 0 0 12px 0; font-size: 1rem;">üí° Specific Changes Required</h4>
      <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 16px;">
        <ul style="margin: 0; padding-left: 20px; color: #e5e7eb;">
          {% for change in improvement.changes %}
          <li style="margin-bottom: 12px; line-height: 1.5;">
            <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px; font-size: 0.875rem;">{{ change }}</code>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
    
    <!-- Affected Tests -->
    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px;">
      <span style="color: #94a3b8; font-size: 0.875rem;">
        <strong>Affected Tests:</strong> 
        {% for test in improvement.affected_tests[:3] %}
        <span style="background: rgba(139,92,246,0.2); padding: 2px 6px; border-radius: 3px; margin-left: 4px;">{{ test }}</span>
        {% endfor %}
        {% if improvement.affected_tests|length > 3 %}
        <span style="color: #6366f1; margin-left: 4px;">+{{ improvement.affected_tests|length - 3 }} more</span>
        {% endif %}
      </span>
    </div>
  </div>
</div>
{% endfor %}

<div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(34,197,94,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 20px; margin-top: 24px;">
  <h4 style="color: #6ee7b7; margin: 0 0 12px 0;">üìö Implementation Guide</h4>
  <p style="margin: 0 0 16px 0; color: #e5e7eb;">To implement these improvements:</p>
  <ol style="margin: 0; padding-left: 20px; color: #e5e7eb;">
    <li style="margin-bottom: 8px;">Start with <strong style="color: #fca5a5;">HIGH PRIORITY</strong> changes first</li>
    <li style="margin-bottom: 8px;">Review the actual prompt content alongside the recommendations</li>
    <li style="margin-bottom: 8px;">Test each change with the affected test cases</li>
    <li style="margin-bottom: 8px;">Run the full evaluation suite to verify improvements</li>
  </ol>
  <p style="margin: 16px 0 0 0; color: #94a3b8; font-size: 0.875rem;">
    üí° <strong>Pro Tip:</strong> The LLM Judge analyzed the actual prompt content to provide these specific recommendations, ensuring they directly address the root causes of test failures.
  </p>
</div>
{% endif %}

{% if failure_patterns %}
<h2 style="color: white; display: flex; align-items: center; gap: 12px;">
  <span style="background: rgba(59,130,246,0.2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üîç</span>
  Failure Patterns & Common Issues
</h2>

<div style="background: linear-gradient(135deg, rgba(236,72,153,0.1), rgba(168,85,247,0.1)); border: 1px solid rgba(168,85,247,0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
  <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
    <strong style="color: #a78bfa;">üìä Pattern Analysis Insight:</strong> As described in Anthropic's 
    <a href="https://www.anthropic.com/engineering/built-multi-agent-research-system" style="color: #ec4899;">multi-agent systems blog</a>, 
    identifying failure patterns helps refine the orchestrator's decision-making. Common issues often stem from:
  </p>
  <ul style="margin: 8px 0 0 20px; color: #e5e7eb; font-size: 0.875rem;">
    <li>Overly complex interpretations of simple queries (over-orchestration)</li>
    <li>Missing domain experts for comprehensive analysis</li>
    <li>Insufficient task decomposition for specialists</li>
  </ul>
</div>

{% for pattern in failure_patterns %}
<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
  <h3 style="color: #60a5fa; margin: 0 0 12px 0;">{{ pattern.title }}</h3>
  <p style="margin: 0 0 8px 0; color: #e5e7eb;">{{ pattern.description }}</p>
  {% if pattern.common_pattern %}
  <div style="background: rgba(59,130,246,0.1); padding: 12px; border-radius: 8px; font-size: 0.875rem; border: 1px solid rgba(59,130,246,0.1);">
    <strong style="color: #60a5fa;">Common Pattern:</strong> <span style="color: #e5e7eb;">{{ pattern.common_pattern }}</span>
  </div>
  {% endif %}
</div>
{% endfor %}

<div style="background: rgba(59,130,246,0.1); padding: 16px; border-radius: 8px; margin-top: 16px; border: 1px solid rgba(59,130,246,0.2);">
  <p style="margin: 0; font-size: 0.875rem; color: #e5e7eb;">
    üí° <strong style="color: #60a5fa;">Note:</strong> Detailed analysis for each test is available in the Test Results section below.
  </p>
</div>
{% endif %}

<h2 style="color: white; display: flex; align-items: center; gap: 12px;">
  <span style="background: rgba(59,130,246,0.2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üìã</span>
  Test Results Detail
</h2>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1);">
  <strong style="color: #60a5fa;">üìù CMO Agent Prompts Being Tested:</strong>
  <p style="margin: 8px 0; color: #94a3b8; font-size: 0.875rem;">
    The CMO agent uses a multi-stage prompting approach to orchestrate the analysis:
  </p>
  <ul style="margin-top: 8px; color: #e5e7eb;">
    {% for prompt in prompts_tested %}
    <li style="margin-bottom: 8px;">
      <a href="{{ prompt.url }}" style="color: #60a5fa; text-decoration: none;">
        <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">{{ prompt.filename }}</code>
      </a> - {{ prompt.description }}
      {% if "1_gather_data_assess_complexity" in prompt.filename %}
        <span style="color: #94a3b8; font-size: 0.875rem;">(LLM Judge target for: complexity misclassification, some quality issues)</span>
      {% elif "3_assign_specialist_tasks" in prompt.filename %}
        <span style="color: #94a3b8; font-size: 0.875rem;">(LLM Judge target for: specialist selection, task delegation issues)</span>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</div>

<hr style="border: 0; height: 1px; background: rgba(255,255,255,0.1); margin: 32px 0;">

{% for test_case in test_cases %}
<h2 style="color: white;">Test Case: {{ test_case.test_case_id }} {{ test_case.status_icon }}</h2>

<div class="test-card">
  <div class="test-card-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; color: white; font-size: 1.25rem;">Test Case: {{ test_case.test_case_id }}</h3>
      <span style="background: {{ test_case.status_badge_color }}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.875rem; font-weight: 600;">{{ test_case.status_text }}</span>
    </div>
  </div>
  
  <div style="padding: 24px;">
    <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1);">
      <strong style="color: #60a5fa;">Health Query:</strong>
      <p style="margin: 8px 0 0 0; color: #e5e7eb;">{{ test_case.query }}</p>
    </div>
    
    <!-- Collapsible Health Query Response -->
    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 16px; overflow: hidden;">
      <div class="collapsible collapsible-header" onclick="toggleSection(this)">
        <strong style="color: #60a5fa;">Health Query Response/Analysis</strong>
        <span class="collapsible-arrow">‚ñº</span>
      </div>
      <div class="collapsible-content">
        <div style="padding: 16px; background: rgba(0,0,0,0.3); color: #e5e7eb; font-size: 0.875rem; line-height: 1.6;">
          <pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">{{ test_case.approach_text }}</pre>
        </div>
      </div>
    </div>
    
    {% if test_case.response_time %}
    <div style="display: flex; gap: 16px; margin: 16px 0;">
      <div style="background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 8px; font-size: 0.875rem; border: 1px solid rgba(255,255,255,0.1);">
        <strong style="color: #60a5fa;">Response Time:</strong> <span style="color: #e5e7eb;">{{ test_case.response_time }}s</span>
      </div>
    </div>
    {% endif %}
    
    <h4 style="color: #e5e7eb;">Evaluation Summary</h4>
    
    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden; margin: 16px 0;">
      <table style="width: 100%; border-collapse: collapse; color: #e5e7eb;">
        <thead>
          <tr style="background: rgba(255,255,255,0.1);">
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">Dimension</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">Expected</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">Actual</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">Score</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">Target</th>
            <th style="padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for dimension in test_case.evaluation_dimensions %}
          <tr {% if dimension.has_components %}class="collapsible" onclick="toggleDimensionRow(this)" style="cursor: pointer; {% if loop.index0 % 2 == 1 %}background: rgba(255,255,255,0.02);{% endif %}"{% else %}{% if loop.index0 % 2 == 1 %}style="background: rgba(255,255,255,0.02);"{% endif %}{% endif %}>
            <td style="padding: 12px; font-weight: 600;">
              {% if dimension.has_components %}
              <span class="dimension-arrow" style="display: inline-block; width: 20px; transition: transform 0.3s ease;">‚ñ∂</span>
              {% endif %}
              {{ dimension.name }}
            </td>
            <td style="padding: 12px; {% if dimension.expected_small %}font-size: 0.875rem;{% endif %}">{{ dimension.expected }}</td>
            <td style="padding: 12px; {% if dimension.actual_small %}font-size: 0.875rem;{% endif %}">{{ dimension.actual }}</td>
            <td style="padding: 12px;">{{ dimension.score }}</td>
            <td style="padding: 12px;">{{ dimension.target }}</td>
            <td style="padding: 12px;">
              <span style="background: {{ dimension.status_color }}; color: {{ dimension.status_text_color }}; padding: 4px 8px; border-radius: 4px;">{{ dimension.status }}</span>
            </td>
          </tr>
          {% if dimension.has_components %}
          <tr class="dimension-components" style="display: none; background: rgba(255,255,255,0.03);">
            <td colspan="6" style="padding: 0;">
              <div style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                <h5 style="color: #60a5fa; margin: 0 0 12px 0; font-size: 0.875rem;">Quality Score Components:</h5>
                <table style="width: 100%; font-size: 0.875rem;">
                  <thead>
                    <tr style="background: rgba(255,255,255,0.05);">
                      <th style="padding: 8px; text-align: left; color: #94a3b8;">Component</th>
                      <th style="padding: 8px; text-align: left; color: #94a3b8;">Weight</th>
                      <th style="padding: 8px; text-align: left; color: #94a3b8;">Score</th>
                      <th style="padding: 8px; text-align: left; color: #94a3b8;">Weighted</th>
                      <th style="padding: 8px; text-align: left; color: #94a3b8;">Description</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for component in dimension.components %}
                    <tr {% if loop.index0 % 2 == 1 %}style="background: rgba(255,255,255,0.02);"{% endif %}>
                      <td style="padding: 8px; font-weight: 600; color: #e5e7eb;">{{ component.name }}</td>
                      <td style="padding: 8px; color: #94a3b8;">{{ component.weight }}</td>
                      <td style="padding: 8px; color: #e5e7eb;">{{ component.score }}</td>
                      <td style="padding: 8px; color: #60a5fa;">{{ component.weighted }}</td>
                      <td style="padding: 8px; color: #94a3b8; font-size: 0.75rem;">{{ component.description }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>


    {% if test_case.failure_analysis %}
    <!-- Enhanced Failure Analysis Section -->
    <div class="failure-card">
      <div class="failure-header">
        <div class="failure-icon">üî¨</div>
        <h4 style="color: white; margin: 0; font-size: 1.25rem;">LLM Judge Failure Analysis</h4>
      </div>
      
      <div style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.3); border-radius: 12px; padding: 12px; margin: 0 0 16px 0;">
        <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
          <strong style="color: #a78bfa;">üîç Analysis Method:</strong> Following Anthropic's testing best practices, we use an LLM Judge to analyze failures and provide 
          specific, actionable recommendations for prompt improvements. This goes beyond simple metric checking to understand <em>why</em> the agent failed and <em>how</em> to fix it.
        </p>
      </div>
      
      {% for failure in test_case.failure_analysis %}
      <div class="failure-item">
        <p style="margin: 0 0 8px 0; color: white; font-weight: 600; font-size: 1.1rem;">
          {{ failure.icon }} {{ failure.title }}
        </p>
        <p style="margin: 0; color: #e5e7eb;">
          {{ failure.description }}
        </p>
      </div>
      
      {% if failure.root_cause %}
      <div class="failure-item">
        <p style="margin: 0 0 8px 0; color: white; font-weight: 600;">
          üîç Root Cause Analysis
        </p>
        <p style="margin: 0; color: #e5e7eb; font-size: 0.9rem;">
          {{ failure.root_cause }}
        </p>
      </div>
      {% endif %}
      
      {% if failure.priority or failure.prompt_file %}
      <div style="display: flex; align-items: center; gap: 12px; margin: 20px 0;">
        {% if failure.priority %}
        <span style="background: {{ failure.priority_color }}; color: white; padding: 6px 16px; border-radius: 20px; font-weight: 600;">{{ failure.priority }} PRIORITY</span>
        {% endif %}
        {% if failure.prompt_file %}
        <code style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 6px; font-size: 0.875rem;">{{ failure.prompt_file }}</code>
        {% endif %}
      </div>
      {% endif %}
      
      {% if failure.issues %}
      <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <p style="margin: 0 0 12px 0; color: #fbbf24; font-weight: 600;">
          üîç Issues Identified
        </p>
        <ul style="margin: 0; padding-left: 20px; color: #e5e7eb;">
          {% for issue in failure.issues %}
          <li style="margin-bottom: 8px;">{{ issue }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      {% if failure.recommendations %}
      <div class="recommendation-box">
        <p style="margin: 0 0 12px 0; color: #60a5fa; font-weight: 600;">
          üí° Recommended Prompt Changes
        </p>
        <ul style="margin: 0; padding-left: 20px; color: #e5e7eb;">
          {% for rec in failure.recommendations %}
          <li style="margin-bottom: 8px;">{{ rec }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      {% if failure.expected_impact %}
      <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; padding: 16px; margin-top: 16px;">
        <p style="margin: 0; color: #6ee7b7; font-weight: 600;">
          üìà Expected Impact
        </p>
        <p style="margin: 8px 0 0 0; color: #e5e7eb; font-size: 0.9rem;">
          {{ failure.expected_impact }}
        </p>
      </div>
      {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    
    {% if test_case.prompt_improvements %}
    <!-- LLM Judge Prompt Improvement Recommendations for this test case -->
    <div style="background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(139,92,246,0.05)); border: 2px solid rgba(139,92,246,0.3); border-radius: 16px; padding: 24px; margin-top: 24px; position: relative; overflow: hidden;">
      <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #a78bfa, #8b5cf6, #a78bfa); animation: pulse 2s ease-in-out infinite;"></div>
      
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
        <div style="background: rgba(139,92,246,0.2); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üí°</div>
        <h4 style="color: white; margin: 0; font-size: 1.25rem;">Prompt Improvement Recommendations</h4>
      </div>
      
      <div style="background: rgba(236,72,153,0.1); border: 1px solid rgba(236,72,153,0.3); border-radius: 12px; padding: 12px; margin-bottom: 16px;">
        <p style="margin: 0; color: #e5e7eb; font-size: 0.875rem;">
          <strong style="color: #ec4899;">üéØ Targeted Improvements:</strong> The LLM Judge analyzed this specific test failure and identified prompt improvements that would help the CMO agent pass this test.
        </p>
      </div>
      
      {% for improvement in test_case.prompt_improvements %}
      <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div>
            <h5 style="color: #a78bfa; margin: 0 0 4px 0; font-size: 1rem;">üìÑ {{ improvement.prompt_file }}</h5>
            <span style="color: #94a3b8; font-size: 0.75rem;">Failed Dimension: {{ improvement.dimension }}</span>
          </div>
          <span style="background: {% if improvement.priority == 'high' %}rgba(239,68,68,0.3){% elif improvement.priority == 'medium' %}rgba(251,191,36,0.3){% else %}rgba(34,197,94,0.3){% endif %}; color: {% if improvement.priority == 'high' %}#fca5a5{% elif improvement.priority == 'medium' %}#fcd34d{% else %}#86efac{% endif %}; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
            {{ improvement.priority|upper }}
          </span>
        </div>
        
        {% if improvement.issues %}
        <div style="margin-bottom: 12px;">
          <p style="color: #fbbf24; font-size: 0.875rem; margin: 0 0 8px 0; font-weight: 600;">Issues:</p>
          <ul style="margin: 0; padding-left: 20px; color: #e5e7eb; font-size: 0.875rem;">
            {% for issue in improvement.issues %}
            {% if issue %}
            <li style="margin-bottom: 4px;">{{ issue }}</li>
            {% endif %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if improvement.changes %}
        <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 12px;">
          <p style="color: #60a5fa; font-size: 0.875rem; margin: 0 0 8px 0; font-weight: 600;">Recommended Changes:</p>
          <ul style="margin: 0; padding-left: 20px; color: #e5e7eb; font-size: 0.875rem;">
            {% for change in improvement.changes %}
            <li style="margin-bottom: 4px;">{{ change }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if improvement.missing_specialists %}
        <div style="margin-top: 12px; padding: 8px; background: rgba(251,191,36,0.1); border-radius: 6px;">
          <p style="color: #fbbf24; font-size: 0.75rem; margin: 0; font-weight: 600;">Missing Specialists:</p>
          {% for spec, reason in improvement.missing_specialists.items() %}
          <p style="color: #e5e7eb; font-size: 0.75rem; margin: 4px 0 0 0;">‚Ä¢ <strong>{{ spec }}:</strong> {{ reason }}</p>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<hr style="border: 0; height: 1px; background: rgba(255,255,255,0.1); margin: 32px 0;">
{% endfor %}

<h2 style="color: white; display: flex; align-items: center; gap: 12px;">
  <span style="background: rgba(59,130,246,0.2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">üìä</span>
  Visualizations
</h2>

<h3 style="color: white;">Performance by Dimension</h3>
<div style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 16px;">
The chart below shows how the CMO Agent performs across each evaluation dimension compared to target thresholds:
</div>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 16px; padding: 40px; text-align: center; border: 2px dashed rgba(255,255,255,0.2); margin: 24px 0;">
  <div style="font-size: 3rem; margin-bottom: 16px;">üìä</div>
  <h4 style="color: #60a5fa; margin-bottom: 8px;">Dimension Scores</h4>
  <p style="color: #cbd5e1; font-size: 0.875rem;">Performance across evaluation dimensions vs. target thresholds</p>
  <img src="./dimension_scores.png" alt="Dimension Scores Chart" style="max-width: 100%; height: auto; margin-top: 20px; border-radius: 8px;">
</div>

<h3 style="color: white;">Additional Performance Charts</h3>

<div style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; margin-top: 24px; border: 1px solid rgba(255,255,255,0.1);">
  <p style="margin: 0 0 16px 0; color: #60a5fa; font-weight: 600;">Click on any chart below to view additional performance insights:</p>
  
  <div style="background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <table style="width: 100%; border-collapse: collapse; color: #e5e7eb;">
      <thead>
        <tr style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(168,85,247,0.2));">
          <th style="padding: 16px; text-align: left; font-weight: 600;">Chart</th>
          <th style="padding: 16px; text-align: left; font-weight: 600;">What It Shows</th>
          <th style="padding: 16px; text-align: left; font-weight: 600;">Key Insights</th>
        </tr>
      </thead>
      <tbody>
        {% for chart in additional_charts %}
        <tr style="{% if loop.index0 % 2 == 1 %}background: rgba(255,255,255,0.02); {% endif %}border-bottom: 1px solid rgba(255,255,255,0.1);">
          <td style="padding: 16px;">
            <a href="{{ chart.url }}" style="color: #60a5fa; text-decoration: none; font-weight: 600;">{{ chart.name }}</a>
          </td>
          <td style="padding: 16px;">{{ chart.description }}</td>
          <td style="padding: 16px; color: #94a3b8;">{{ chart.insights }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

</div>
</body>
<script>
function toggleSection(element) {
  const content = element.nextElementSibling;
  const arrow = element.querySelector('.collapsible-arrow');
  
  content.classList.toggle('open');
  arrow.classList.toggle('open');
}

function toggleDimensionRow(row) {
  const componentRow = row.nextElementSibling;
  const arrow = row.querySelector('.dimension-arrow');
  
  if (componentRow && componentRow.classList.contains('dimension-components')) {
    if (componentRow.style.display === 'none') {
      componentRow.style.display = 'table-row';
      arrow.style.transform = 'rotate(90deg)';
    } else {
      componentRow.style.display = 'none';
      arrow.style.transform = 'rotate(0deg)';
    }
  }
}
</script>
</html>